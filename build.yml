name: Build and Publish Quarto Dashboard

on:
    schedule:
        - cron: "0 0 * * *" # Runs every midnight
    workflow_dispatch: # Allows manual triggering

jobs:
    build-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Quarto
              uses: quarto-dev/quarto-actions/setup@v2

            - name: Set up R
              uses: r-lib/actions/setup-r@v2
              with:
                  r-version: "4.4.2"

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

            - name: Install R Dependencies
              uses: r-lib/actions/setup-renv@v2
              with:
                  cache-version: 1

            - name: Run data operations
              run: Rscript data_operations.r
              env:
                  REDCAP_API_TOKEN: ${{ secrets.REDCAP_API_TOKEN }}

            - name: Run data tests
              run: |
                  Rscript data_tests.r
              continue-on-error: false # This will cause the workflow to fail if tests fail

            - name: Render Quarto dashboard
              uses: quarto-dev/quarto-actions/render@v2
              with:
                  input: aps-dashboard.qmd

            - name: Deploy to GitHub Pages
              if: success() # Only run if all previous steps succeeded
              uses: quarto-dev/quarto-actions/publish@v2
              with:
                  target: gh-pages
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
